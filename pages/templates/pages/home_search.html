<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../static/css/design.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400&family=Open+Sans:ital,wght@0,400;0,700;1,400&family=Lato:ital,wght@0,400;0,700;1,400&family=Montserrat:ital,wght@0,400;0,700;1,400&family=Nunito:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap">

    <title>JammyJobber Search</title>
</head>
<body>

    <header>
        <h1>üçì Welcome to JammyJobber! üçì</h1>
        <p class="catchline">Let's find your jam</p>
    </header>
    
    <div class="main-page">

        <div class="search-box">
            <label for="search-input">Enter query here</label>
            <form action="" method="get">
                <input type="text" name="query" placeholder="Search here...">
                <input type="text" name="location_query" placeholder="Enter preferred location...">
                <button type="submit">Submit</button>
            </form>
        </div>

        <div class="add-cv">
            {% if submitted %}
                Your CV was Submitted Successfully
            {% else %}
                <form action method ="POST" enctype = "multipart/form-data">
                {% csrf_token %}
                    <label for="id_pdf">Add CV to Database</label>
                    <input type="file" name="pdf" required id="id_pdf">
                <div class="submit-button-section">
                    <button class="submit-button" type="submit"> Update </button>
                </div>
                </form>
            {% endif %}
        </div>

    </div>

    <ul class="job-listings">
        <button class="expand-btn" onclick="toggleSuggested(this)">Why were these jobs suggested?</button>
        <div id="whysuggested" class="job-description">
        <p id="suggested"></p>
        </div>
        {% for job in job_list %}
            <li class="job-listing">
                <a href=" {{ job.link }} "><h3>{{ job.title }}</h3></a>
                <p>{{ job.company }} @ {{ job.location }}</p>
                <button class="expand-btn" onclick="toggleDescription(this, '{{ job.job_id }}')">Show Description</button>
                <button type="button" class="expand-btn" name="id" value = '{{ job.job_id }}' ><a href="/?id={{ job.job_id }}">Show Similar</a></button>
                <div id="description-{{ job.job_id }}" class="job-description">
                    <p>{{ job.description }}</p>
                </div>
            </li>
        {% endfor %}
    </ul>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="../../static/js/job_listing.js"></script>
    <script type="module">
        import { pipeline, AutoModel, AutoTokenizer } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0';
            
        window.toggleSuggested = async function toggleSuggested(button) { 
            let pipe = await pipeline('text2text-generation', 'Xenova/LaMini-Flan-T5-783M');
            let jobs = {{ json_list|safe }};
            let job = jobs[0];
            let job_query = {{ query|safe }};
            let out = await pipe("Candidate said: " + job_query + " The job suggested was: " + job + "Give 4 bulletpoints explaining why the suggested job was a good fit for you or a bad fit.", {
                max_new_tokens: 1000,
              });
            let text = out[0].generated_text
            console.log(text)
            
            // Find the index of the 4th dash
            let fourthDashIndex = -1;
            for (let i = 0, count = 0; i < text.length; i++) {
                if (text[i] === '-') {
                    count++;
                    if (count === 5) {
                        fourthDashIndex = i;
                        break;
                    }
                }
            }

            // If the 4th dash was found, manipulate the string accordingly
            if (fourthDashIndex !== -1) {
                text = text.substring(0, fourthDashIndex).replace(/-/g, '<br>-');
            } else {
                text = text.replace(/-/g, '<br>-')
            }
            $(button).siblings(`#whysuggested`).toggle();
            document.getElementById("suggested").innerHTML = text;
        }
    </script>
 
</body>
</html>

